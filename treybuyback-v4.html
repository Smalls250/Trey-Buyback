<script>
// ═══════════════════════════════════════════
//  STATE + STORAGE
// ═══════════════════════════════════════════
let ST = { leads: [], inventory: [], alerts: [], sold: [] };
let KEYS = { ebay: '', email: '', svc: '', tmpl: '', pubkey: '' };
let editLeadId = null, sellItemId = null, aiMode = 'negotiate';

let aiHistory = [{
  role: 'assistant',
  content: "Hey! I'm your Trey Buyback AI. I can help you negotiate deals, check if something's worth buying, handle objections, or write ad copy. What do you need?"
}];

let calcGrade = 'swap';
let calcDeds = { back: false, lens: false, batt: false, rep: false };

function save() {
  try { localStorage.setItem('tb4', JSON.stringify(ST)); } catch (e) {}
}
function saveKeys() {
  try { localStorage.setItem('tb4k', JSON.stringify(KEYS)); } catch (e) {}
}

function load() {
  try {
    const s = localStorage.getItem('tb4');
    if (s) ST = { leads: [], inventory: [], alerts: [], sold: [], ...JSON.parse(s) };
  } catch (e) {}

  try {
    const k = localStorage.getItem('tb4k');
    if (k) KEYS = { ...KEYS, ...JSON.parse(k) };
  } catch (e) {}

  // Only init EmailJS if it actually loaded
  if (KEYS.pubkey && window.emailjs && typeof window.emailjs.init === 'function') {
    try { emailjs.init(KEYS.pubkey); } catch (e) {}
  }
}
load();

// ═══════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════
function init() {
  const d = new Date();

  const topDate = document.getElementById('topDate');
  if (topDate) {
    topDate.textContent = d.toLocaleDateString('en-US', {
      weekday: 'short', month: 'short', day: 'numeric'
    });
  }

  const h = d.getHours();
  const greet = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
  const dashGreet = document.getElementById('dashGreet');
  if (dashGreet) dashGreet.textContent = greet + ' — ready to flip?';

  // IMPORTANT: only call these if they exist in your file further down
  if (typeof buildCalcModels === 'function') buildCalcModels();
  if (typeof renderDash === 'function') renderDash();
  if (typeof renderAI === 'function') renderAI();
  if (typeof counts === 'function') counts();
  if (typeof updateKS === 'function') updateKS();

  // If the gate is hidden but still blocking clicks (rare), force-disable it:
  const gate = document.getElementById('gate');
  if (gate && gate.style.display === 'none') gate.style.pointerEvents = 'none';
}

// Run init safely on GitHub Pages
document.addEventListener('DOMContentLoaded', init);

// ═══════════════════════════════════════════
//  NAVIGATION
// ═══════════════════════════════════════════
function nav(p) {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.nav-item, .mob-item').forEach(x => x.classList.remove('active'));

  const page = document.getElementById('page-' + p);
  if (page) page.classList.add('active');

  document.querySelectorAll('.nav-item, .mob-item').forEach(x => {
    const oc = x.getAttribute('onclick') || '';
    if (oc.includes("'" + p + "'")) x.classList.add('active');
  });

  const fns = {
    dashboard: typeof renderDash === 'function' ? renderDash : null,
    leads: typeof renderLeads === 'function' ? renderLeads : null,
    pipeline: typeof renderPipeline === 'function' ? renderPipeline : null,
    followups: typeof renderFollowups === 'function' ? renderFollowups : null,
    inventory: typeof renderInventory === 'function' ? renderInventory : null,
    alerts: typeof renderAlerts === 'function' ? renderAlerts : null,
    profits: typeof renderProfits === 'function' ? renderProfits : null
  };
  if (fns[p]) fns[p]();

  if (p === 'prices') {
    const warn = document.getElementById('api-warn');
    if (warn) warn.style.display = KEYS.ebay ? 'none' : 'block';
  }

  if (typeof counts === 'function') counts();
}

// ═══════════════════════════════════════════
//  MODALS
// ═══════════════════════════════════════════
function openModal(id) {
  if (id === 'addLead' && !editLeadId) {
    ['l-name','l-phone','l-device','l-notes','l-offer','l-asking','l-followup'].forEach(f => {
      const el = document.getElementById(f);
      if (el) el.value = '';
    });
    const src = document.getElementById('l-source');
    const st  = document.getElementById('l-status');
    const cat = document.getElementById('l-cat');
    const ttl = document.getElementById('lead-modal-title');
    if (src) src.value = 'FB Marketplace';
    if (st)  st.value  = 'new';
    if (cat) cat.value = 'Phone';
    if (ttl) ttl.textContent = 'NEW LEAD';
  }

  if (id === 'settings' && typeof loadSettingsUI === 'function') loadSettingsUI();

  const m = document.getElementById('modal-' + id);
  if (m) m.classList.add('open');
}

function closeModal(id) {
  const m = document.getElementById('modal-' + id);
  if (m) m.classList.remove('open');
  if (id === 'addLead') editLeadId = null;
}

// Click outside modal to close
document.querySelectorAll('.overlay').forEach(o => {
  o.addEventListener('click', e => {
    if (e.target === o) o.classList.remove('open');
  });
});

// ═══════════════════════════════════════════
//  TOAST
// ═══════════════════════════════════════════
function toast(msg, type = 'success') {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.classList.remove('show'), 2800);
}

// ═══════════════════════════════════════════
//  HELPERS
// ═══════════════════════════════════════════
function fmtD(iso) {
  if (!iso) return '—';
  return new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
function fmtM(n) {
  return '$' + (Number(n || 0)).toLocaleString();
}
function uid() {
  return Date.now() + Math.random().toString(36).slice(2, 6);
}
function sPill(s) {
  const m = {
    new: ['p-new','NEW'],
    active: ['p-active','ACTIVE'],
    follow: ['p-follow','FOLLOW-UP'],
    closed: ['p-closed','CLOSED'],
    lost: ['p-lost','LOST']
  };
  const [cls, label] = m[s] || ['p-new', s];
  return `<span class="pill ${cls}">${label}</span>`;
}
function counts() {
  const ncLeads = document.getElementById('nc-leads');
  const ncFu    = document.getElementById('nc-fu');
  const ncAl    = document.getElementById('nc-alerts');

  if (ncLeads) ncLeads.textContent = ST.leads.filter(l => l.status === 'new').length;
  if (ncFu) ncFu.textContent = ST.leads.filter(l => l.followup && new Date(l.followup) <= new Date()).length;
  if (ncAl) ncAl.textContent = ST.alerts.length;
}

// ═══════════════════════════════════════════
//  FIX: your STAGES var had bad dashes (var(–gold))
// ═══════════════════════════════════════════
const STAGES = [
  { key:'new',    label:'New',          c:'var(--blue)' },
  { key:'active', label:'Negotiating',  c:'var(--gold)' },
  { key:'follow', label:'Follow-Up',    c:'var(--purple)' },
  { key:'closed', label:'Bought ✓',     c:'var(--green)' },
  { key:'lost',   label:'Lost',         c:'var(--red)' }
];

// ═══════════════════════════════════════════
//  FIX: broken regex in formatAIMsg
// ═══════════════════════════════════════════
function formatAIMsg(text) {
  return String(text || '')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/^> (.+)$/gm, '<div class="ai-sline">$1</div>')
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>');
}
</script>
